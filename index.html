<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Not a Label - AI Music Terminal</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="AI-powered music creation terminal. Create, share, and collaborate through natural language commands.">
  <meta name="theme-color" content="#00ff00">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Not a Label Terminal">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  
  <style>
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box;
    }
    
    body { 
      background: #000; 
      color: #00ff00; 
      font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
      overflow: hidden;
      height: 100vh;
      position: fixed;
      width: 100%;
      touch-action: manipulation;
    }
    
    /* Terminal Container */
    .terminal {
      height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    
    /* Terminal Header */
    .terminal-header {
      background: linear-gradient(135deg, #111, #001100);
      border-bottom: 1px solid #00ff0055;
      padding: 8px 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      min-height: 45px;
      flex-shrink: 0;
      backdrop-filter: blur(10px);
    }
    
    .terminal-title {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #00ff00;
      font-size: 14px;
      font-weight: bold;
    }
    
    .logo-dot {
      width: 8px;
      height: 8px;
      background: #00ff00;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    .terminal-status {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 11px;
      color: #00ff0088;
    }
    
    .status-item {
      cursor: pointer;
      transition: color 0.2s;
      padding: 2px 4px;
      border-radius: 3px;
    }
    
    .status-item:hover {
      color: #00ff00;
      background: rgba(0, 255, 0, 0.1);
    }
    
    .network-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #00ff00;
      margin-right: 4px;
    }
    
    .network-indicator.offline {
      background: #ff0066;
      animation: pulse 1s infinite;
    }
    
    /* Terminal Content */
    .terminal-content {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
      background: radial-gradient(ellipse at center, rgba(0, 255, 0, 0.02) 0%, transparent 70%);
    }
    
    /* Terminal Lines */
    .terminal-line {
      margin: 2px 0;
      line-height: 1.4;
      font-size: 13px;
      word-wrap: break-word;
      white-space: pre-wrap;
      animation: fadeIn 0.3s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .system-line { color: #00ffff; }
    .error-line { color: #ff0066; font-weight: bold; }
    .input-line { color: #00ff00; font-weight: bold; }
    .output-line { color: #cccccc; }
    .success-line { color: #00ff88; font-weight: bold; }
    .info-line { color: #ffaa00; }
    .dim-line { color: #00ff0066; }
    .highlight-line { 
      color: #00ff00; 
      background: rgba(0, 255, 0, 0.1);
      padding: 4px 8px;
      border-left: 3px solid #00ff00;
      margin: 4px 0;
      border-radius: 0 4px 4px 0;
    }
    
    /* Enhanced Strudel Player */
    .inline-strudel-player {
      margin: 12px 0;
      padding: 16px;
      background: linear-gradient(135deg, #001100, #002200);
      border: 1px solid #00ff0050;
      border-radius: 8px;
      font-family: inherit;
      box-shadow: 0 4px 12px rgba(0, 255, 0, 0.1);
    }
    
    .player-header {
      color: #00ff00;
      font-size: 13px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
    }
    
    .pattern-id {
      color: #00ff0066;
      font-size: 10px;
      cursor: pointer;
      padding: 2px 6px;
      border: 1px solid #00ff0030;
      border-radius: 3px;
      font-weight: normal;
      transition: all 0.2s;
    }
    
    .pattern-id:hover {
      color: #00ff00;
      border-color: #00ff0050;
      background: rgba(0, 255, 0, 0.05);
    }
    
    .strudel-code {
      background: #000;
      border: 1px solid #00ff0030;
      color: #00ff00;
      padding: 12px;
      border-radius: 4px;
      font-family: inherit;
      font-size: 11px;
      width: 100%;
      min-height: 80px;
      resize: vertical;
      margin-bottom: 12px;
      line-height: 1.4;
    }
    
    .strudel-code:focus {
      outline: none;
      border-color: #00ff00;
      box-shadow: 0 0 8px rgba(0, 255, 0, 0.3);
    }
    
    .player-controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .control-btn {
      background: transparent;
      border: 1px solid #00ff0050;
      color: #00ff00;
      padding: 6px 12px;
      font-family: inherit;
      font-size: 11px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
      min-height: 32px;
    }
    
    .control-btn:hover {
      border-color: #00ff00;
      background: #00ff0020;
      transform: translateY(-1px);
    }
    
    .control-btn:active {
      transform: translateY(0);
    }
    
    .control-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-play.playing { 
      background: #00ff0020; 
      border-color: #00ff00;
    }
    
    .btn-save.saved { 
      background: #ffaa0020; 
      border-color: #ffaa00;
      color: #ffaa00;
    }
    
    /* Enhanced Tables */
    .terminal-table {
      border-collapse: collapse;
      margin: 8px 0;
      font-family: inherit;
      font-size: 12px;
      width: 100%;
      background: rgba(0, 17, 0, 0.3);
      border-radius: 4px;
      overflow: hidden;
    }
    
    .terminal-table th,
    .terminal-table td {
      border: 1px solid #00ff0030;
      padding: 8px 10px;
      text-align: left;
    }
    
    .terminal-table th {
      background: rgba(0, 255, 0, 0.1);
      color: #00ff00;
      font-weight: bold;
      border-bottom: 2px solid #00ff0050;
    }
    
    .terminal-table td {
      color: #cccccc;
    }
    
    .terminal-table tr:hover {
      background: rgba(0, 255, 0, 0.05);
    }
    
    /* Command Input */
    .terminal-input-container {
      background: linear-gradient(135deg, #111, #001100);
      border-top: 1px solid #00ff0055;
      padding: 12px 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
      backdrop-filter: blur(10px);
    }
    
    .terminal-prompt {
      color: #00ff00;
      font-weight: bold;
      white-space: nowrap;
      user-select: none;
      min-width: fit-content;
    }
    
    .terminal-input {
      flex: 1;
      background: transparent;
      border: none;
      color: #00ff00;
      font-family: inherit;
      font-size: 13px;
      outline: none;
      padding: 6px 0;
    }
    
    .terminal-input::placeholder {
      color: #00ff0055;
      font-style: italic;
    }
    
    .voice-btn {
      background: transparent;
      border: 1px solid #00ff0050;
      color: #00ff00;
      padding: 6px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
      min-width: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .voice-btn:hover {
      border-color: #00ff00;
      background: #00ff0020;
    }
    
    .voice-btn.listening {
      background: #ff0066;
      border-color: #ff0066;
      color: white;
      animation: pulse 1s infinite;
    }
    
    .cursor {
      animation: blink 1s infinite;
      color: #00ff00;
    }
    
    /* Command Suggestions */
    .command-suggestions {
      position: absolute;
      bottom: 65px;
      left: 15px;
      right: 15px;
      background: linear-gradient(135deg, #111, #001100);
      border: 1px solid #00ff0050;
      border-radius: 6px;
      max-height: 300px;
      overflow-y: auto;
      display: none;
      z-index: 100;
      box-shadow: 0 8px 24px rgba(0, 255, 0, 0.2);
      backdrop-filter: blur(10px);
    }
    
    .command-suggestions.show {
      display: block;
    }
    
    .suggestion-item {
      padding: 10px 15px;
      cursor: pointer;
      border-bottom: 1px solid #00ff0020;
      color: #cccccc;
      font-size: 12px;
      transition: all 0.2s;
    }
    
    .suggestion-item:hover,
    .suggestion-item.selected {
      background: #00ff0020;
      color: #00ff00;
    }
    
    .suggestion-item:last-child {
      border-bottom: none;
    }
    
    .suggestion-command {
      color: #00ff00;
      font-weight: bold;
      margin-bottom: 2px;
    }
    
    .suggestion-desc {
      color: #00ff0088;
      font-size: 11px;
    }
    
    /* Progress indicators */
    .progress-bar {
      background: #333;
      height: 6px;
      border-radius: 3px;
      overflow: hidden;
      margin: 6px 0;
      width: 200px;
    }
    
    .progress-fill {
      background: linear-gradient(90deg, #00ff00, #00ff88);
      height: 100%;
      transition: width 0.3s ease;
      border-radius: 3px;
    }
    
    /* Loading animations */
    .loading-dots::after {
      content: '';
      animation: loadingDots 1.5s infinite;
    }
    
    @keyframes loadingDots {
      0%, 20% { content: ''; }
      40% { content: '.'; }
      60% { content: '..'; }
      80%, 100% { content: '...'; }
    }
    
    /* Tutorial specific styles */
    .tutorial-box {
      background: linear-gradient(135deg, #001100, #002200);
      border: 1px solid #00ff00;
      border-radius: 6px;
      padding: 15px;
      margin: 10px 0;
      border-left: 4px solid #00ff00;
    }
    
    .achievement-notification {
      background: linear-gradient(135deg, #003300, #002200);
      border: 1px solid #00ff88;
      color: #00ff88;
      padding: 8px 12px;
      border-radius: 4px;
      margin: 4px 0;
      font-size: 12px;
      animation: slideInRight 0.5s ease-out;
    }
    
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    /* PWA Install Banner */
    .pwa-install-banner {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #001100, #003300);
      border: 1px solid #00ff00;
      border-radius: 8px;
      padding: 12px 16px;
      color: #00ff00;
      font-size: 12px;
      cursor: pointer;
      z-index: 200;
      display: none;
      max-width: 90%;
      box-shadow: 0 8px 24px rgba(0, 255, 0, 0.3);
      backdrop-filter: blur(10px);
    }
    
    .pwa-install-banner.show {
      display: block;
      animation: slideUp 0.3s ease-out;
    }
    
    .pwa-install-banner:hover {
      transform: translateX(-50%) translateY(-2px);
      box-shadow: 0 12px 32px rgba(0, 255, 0, 0.4);
    }
    
    /* Animations */
    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(0.95); }
    }
    
    @keyframes slideUp {
      from { transform: translateX(-50%) translateY(100px); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
    
    @keyframes glow {
      0%, 100% { text-shadow: 0 0 5px #00ff00; }
      50% { text-shadow: 0 0 15px #00ff00, 0 0 25px #00ff00; }
    }
    
    /* Mobile Optimizations */
    @media (max-width: 768px) {
      .terminal-header {
        padding: 6px 12px;
        min-height: 40px;
      }
      
      .terminal-title {
        font-size: 12px;
      }
      
      .terminal-content {
        padding: 12px;
      }
      
      .terminal-line {
        font-size: 12px;
      }
      
      .terminal-input-container {
        padding: 10px 12px;
      }
      
      .terminal-input {
        font-size: 16px; /* Prevents zoom on iOS */
      }
      
      .player-controls {
        justify-content: center;
      }
      
      .control-btn {
        min-width: 44px; /* Touch target size */
        padding: 8px 10px;
      }
      
      .command-suggestions {
        bottom: 55px;
        left: 10px;
        right: 10px;
      }
    }
    
    /* Landscape mobile */
    @media screen and (orientation: landscape) and (max-height: 500px) {
      .terminal-header {
        padding: 4px 12px;
        min-height: 35px;
      }
      
      .terminal-content {
        padding: 8px 12px;
      }
      
      .inline-strudel-player {
        padding: 12px;
      }
      
      .strudel-code {
        min-height: 60px;
      }
    }
    
    /* High contrast mode */
    @media (prefers-contrast: high) {
      .terminal-header {
        border-bottom-width: 2px;
      }
      
      .control-btn {
        border-width: 2px;
      }
      
      .inline-strudel-player {
        border-width: 2px;
      }
    }
    
    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    /* Dark mode (already dark, but for system preference) */
    @media (prefers-color-scheme: dark) {
      body {
        background: #000;
      }
    }
    
    /* Focus styles for accessibility */
    .control-btn:focus,
    .terminal-input:focus,
    .voice-btn:focus {
      outline: 2px solid #00ff00;
      outline-offset: 2px;
    }
    
    /* Scrollbar styling */
    .terminal-content::-webkit-scrollbar {
      width: 8px;
    }
    
    .terminal-content::-webkit-scrollbar-track {
      background: #111;
    }
    
    .terminal-content::-webkit-scrollbar-thumb {
      background: #00ff0050;
      border-radius: 4px;
    }
    
    .terminal-content::-webkit-scrollbar-thumb:hover {
      background: #00ff0080;
    }
  </style>
</head>
<body>
  <div class="terminal">
    <!-- Terminal Header -->
    <div class="terminal-header">
      <div class="terminal-title">
        <div class="logo-dot"></div>
        <span>NOT A LABEL TERMINAL v2.0</span>
      </div>
      <div class="terminal-status">
        <div class="status-item" id="userStatus" onclick="showUserMenu()">guest@nal</div>
        <div class="status-item" id="networkStatus">
          <div class="network-indicator" id="networkDot"></div>
          <span id="networkText">online</span>
        </div>
        <div class="status-item" id="timeStatus"></div>
      </div>
    </div>
    
    <!-- Terminal Content -->
    <div class="terminal-content" id="terminalContent">
      <div class="terminal-line system-line">[SYSTEM] Not a Label AI Music Terminal v2.0 initialized</div>
      <div class="terminal-line system-line">[SYSTEM] Natural language processing online</div>
      <div class="terminal-line system-line">[SYSTEM] Web Audio API ready</div>
      <div class="terminal-line system-line">[SYSTEM] PWA features active</div>
      <div class="terminal-line system-line">[SYSTEM] Community feed synchronized</div>
      <div class="terminal-line system-line">[SYSTEM] Voice input available</div>
      <div class="terminal-line system-line"></div>
      <div class="terminal-line highlight-line">ğŸµ Welcome to Not a Label - AI Music Creation Terminal</div>
      <div class="terminal-line output-line">The intelligent music terminal that understands natural language.</div>
      <div class="terminal-line output-line">Just talk to create, explore, and share amazing music!</div>
      <div class="terminal-line output-line"></div>
      <div class="terminal-line info-line">ğŸ’¡ QUICK START:</div>
      <div class="terminal-line dim-line">  "create trap beat"                  - Generate music instantly</div>
      <div class="terminal-line dim-line">  "show community feed"               - Explore what others are making</div>
      <div class="terminal-line dim-line">  "make lo-fi music for studying"     - Context-aware creation</div>
      <div class="terminal-line dim-line">  "tutorial"                          - Interactive walkthrough</div>
      <div class="terminal-line dim-line">  "help"                              - Full command reference</div>
      <div class="terminal-line output-line"></div>
      <div class="terminal-line success-line">ğŸš€ Ready! Try: "hey nala, create some chill music"</div>
      <div class="terminal-line system-line"></div>
    </div>
    
    <!-- Terminal Input -->
    <div class="terminal-input-container">
      <span class="terminal-prompt" id="terminalPrompt">nal@music:~$</span>
      <input type="text" class="terminal-input" id="terminalInput" 
             placeholder="Type any command in natural language..." 
             autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
      <button class="voice-btn" id="voiceBtn" title="Voice input">ğŸ¤</button>
      <span class="cursor">â–ˆ</span>
    </div>
    
    <!-- Command Suggestions -->
    <div class="command-suggestions" id="commandSuggestions">
      <!-- Suggestions will be populated here -->
    </div>
  </div>
  
  <!-- PWA Install Prompt -->
  <div class="pwa-install-banner" id="pwaInstallBanner">
    ğŸ“± Install Not a Label Terminal for the best experience - Add to home screen
  </div>

  <!-- Include Natural Language Processor -->
  <script src="js/nlp.js"></script>
  <script src="js/onboarding.js"></script>

  <script>
    // Global state
    let currentUser = null;
    let accessToken = null;
    let audioContext = null;
    let isAudioInitialized = false;
    let commandHistory = [];
    let historyIndex = -1;
    let suggestionIndex = -1;
    let isOffline = false;
    let deferredPrompt = null;
    let voiceRecognition = null;
    let isListening = false;
    
    // Initialize components
    let nlp = null;
    let onboarding = null;
    
    // Pattern storage
    let activePatterns = new Map();
    let patternCounter = 0;
    
    // Initialize terminal
    document.addEventListener('DOMContentLoaded', function() {
      initializeTerminal();
      initializeNLP();
      initializeOnboarding();
      setupPWA();
      setupNetworkMonitoring();
      setupAudio();
      setupVoiceInput();
      checkExistingSession();
      startClock();
      
      // Check if user should see tutorial
      if (TerminalOnboarding.shouldShowTutorial()) {
        setTimeout(() => {
          addLine('ğŸ’¡ New to Not a Label? Type "tutorial" for an interactive guide!', 'info-line');
        }, 2000);
      }
    });
    
    function initializeTerminal() {
      const terminalInput = document.getElementById('terminalInput');
      
      // Input event handlers
      terminalInput.addEventListener('keydown', handleKeyDown);
      terminalInput.addEventListener('input', handleInput);
      terminalInput.addEventListener('blur', () => {
        // Refocus on mobile to keep keyboard open
        setTimeout(() => terminalInput.focus(), 100);
      });
      
      // Auto-focus terminal
      terminalInput.focus();
      
      // Click anywhere to focus terminal
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.command-suggestions') && 
            !e.target.closest('.inline-strudel-player') &&
            !e.target.closest('.voice-btn')) {
          terminalInput.focus();
        }
      });
      
      // Handle URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('quick')) {
        setTimeout(() => executeQuickCommand(urlParams.get('quick')), 1000);
      }
      if (urlParams.get('voice') === 'true') {
        setTimeout(() => startVoiceInput(), 500);
      }
    }
    
    function initializeNLP() {
      nlp = new NaturalLanguageProcessor();
      addLine('ğŸ§  Natural language processor ready', 'system-line');
    }
    
    function initializeOnboarding() {
      onboarding = new TerminalOnboarding({
        addLine: addLine,
        addHTML: addHTML,
        generateMusicFromOnboarding: generateMusicFromOnboarding,
        showCommunityFeed: showCommunityFeed,
        focusInput: () => document.getElementById('terminalInput').focus()
      });
    }
    
    // Input handling
    function handleKeyDown(event) {
      const input = event.target;
      const suggestions = document.getElementById('commandSuggestions');
      
      switch (event.key) {
        case 'Enter':
          event.preventDefault();
          if (suggestions.classList.contains('show') && suggestionIndex >= 0) {
            const selectedSuggestion = suggestions.children[suggestionIndex];
            const command = selectedSuggestion.querySelector('.suggestion-command').textContent;
            input.value = command;
            hideSuggestions();
          }
          executeCommand(input.value);
          break;
          
        case 'ArrowUp':
          event.preventDefault();
          if (suggestions.classList.contains('show')) {
            navigateSuggestions(-1);
          } else {
            navigateHistory(-1);
          }
          break;
          
        case 'ArrowDown':
          event.preventDefault();
          if (suggestions.classList.contains('show')) {
            navigateSuggestions(1);
          } else {
            navigateHistory(1);
          }
          break;
          
        case 'Escape':
          hideSuggestions();
          break;
          
        case 'Tab':
          event.preventDefault();
          if (suggestions.classList.contains('show') && suggestionIndex >= 0) {
            const selectedSuggestion = suggestions.children[suggestionIndex];
            const command = selectedSuggestion.querySelector('.suggestion-command').textContent;
            input.value = command;
            hideSuggestions();
          }
          break;
      }
    }
    
    function handleInput(event) {
      const query = event.target.value;
      
      if (query.length >= 2) {
        showSuggestions(query);
      } else {
        hideSuggestions();
      }
    }
    
    // Command suggestions
    const commandSuggestions = [
      { cmd: "create trap beat", desc: "Generate modern trap pattern" },
      { cmd: "make lo-fi music for studying", desc: "Create chill study beats" },
      { cmd: "generate drill pattern", desc: "UK drill with sliding 808s" },
      { cmd: "show community feed", desc: "Browse recent patterns" },
      { cmd: "what's trending", desc: "Popular community content" },
      { cmd: "my profile", desc: "View your account and patterns" },
      { cmd: "who's online", desc: "See active creators" },
      { cmd: "tutorial", desc: "Interactive walkthrough" },
      { cmd: "help", desc: "Full command reference" },
      { cmd: "create jazz chords", desc: "Generate jazz progression" },
      { cmd: "make house music", desc: "Create house 4/4 pattern" },
      { cmd: "generate afrobeats", desc: "African rhythm patterns" },
      { cmd: "create synthwave", desc: "Retro electronic vibes" },
      { cmd: "recent patterns", desc: "Latest community creations" },
      { cmd: "save this pattern", desc: "Save current pattern" }
    ];
    
    function showSuggestions(query) {
      const suggestions = document.getElementById('commandSuggestions');
      const filtered = commandSuggestions.filter(item => 
        item.cmd.toLowerCase().includes(query.toLowerCase()) ||
        item.desc.toLowerCase().includes(query.toLowerCase())
      ).slice(0, 8);
      
      if (filtered.length === 0) {
        hideSuggestions();
        return;
      }
      
      suggestions.innerHTML = filtered.map((item, index) => `
        <div class="suggestion-item" data-index="${index}">
          <div class="suggestion-command">${item.cmd}</div>
          <div class="suggestion-desc">${item.desc}</div>
        </div>
      `).join('');
      
      // Add click handlers
      suggestions.querySelectorAll('.suggestion-item').forEach((item, index) => {
        item.addEventListener('click', () => {
          const command = item.querySelector('.suggestion-command').textContent;
          document.getElementById('terminalInput').value = command;
          hideSuggestions();
          executeCommand(command);
        });
      });
      
      suggestions.classList.add('show');
      suggestionIndex = -1;
    }
    
    function hideSuggestions() {
      document.getElementById('commandSuggestions').classList.remove('show');
      suggestionIndex = -1;
    }
    
    function navigateSuggestions(direction) {
      const suggestions = document.getElementById('commandSuggestions');
      const items = suggestions.querySelectorAll('.suggestion-item');
      
      if (items.length === 0) return;
      
      if (suggestionIndex >= 0) {
        items[suggestionIndex].classList.remove('selected');
      }
      
      suggestionIndex += direction;
      if (suggestionIndex < 0) suggestionIndex = items.length - 1;
      if (suggestionIndex >= items.length) suggestionIndex = 0;
      
      items[suggestionIndex].classList.add('selected');
      items[suggestionIndex].scrollIntoView({ block: 'nearest' });
    }
    
    function navigateHistory(direction) {
      const input = document.getElementById('terminalInput');
      
      if (direction === -1 && historyIndex > 0) {
        historyIndex--;
        input.value = commandHistory[historyIndex];
      } else if (direction === 1 && historyIndex < commandHistory.length - 1) {
        historyIndex++;
        input.value = commandHistory[historyIndex];
      } else if (direction === 1 && historyIndex === commandHistory.length - 1) {
        historyIndex = commandHistory.length;
        input.value = '';
      }
    }
    
    // Command execution
    function executeCommand(command) {
      if (!command.trim()) return;
      
      // Add to history
      commandHistory.push(command);
      historyIndex = commandHistory.length;
      
      // Clear input
      document.getElementById('terminalInput').value = '';
      hideSuggestions();
      
      // Display command
      addLine(`${getCurrentPrompt()} ${command}`, 'input-line');
      
      // Check if onboarding should handle this
      if (onboarding && onboarding.isActive && onboarding.handleInput(command)) {
        scrollToBottom();
        return;
      }
      
      // Handle special commands first
      if (handleSpecialCommands(command.trim())) {
        scrollToBottom();
        return;
      }
      
      // Process with NLP
      processNaturalLanguageCommand(command.trim());
      scrollToBottom();
    }
    
    function handleSpecialCommands(command) {
      const lowerCommand = command.toLowerCase();
      
      if (lowerCommand === 'clear') {
        clearTerminal();
        return true;
      }
      
      if (lowerCommand === 'tutorial') {
        onboarding.start();
        return true;
      }
      
      if (lowerCommand === 'skip tutorial' && onboarding.isActive) {
        onboarding.skip();
        return true;
      }
      
      if (lowerCommand === 'help') {
        showHelp();
        return true;
      }
      
      if (lowerCommand === 'login') {
        showLogin();
        return true;
      }
      
      if (lowerCommand === 'register') {
        showRegister();
        return true;
      }
      
      return false;
    }
    
    function processNaturalLanguageCommand(command) {
      if (!nlp) {
        addLine('âŒ Natural language processor not ready', 'error-line');
        return;
      }
      
      // Show thinking indicator
      addLine('ğŸµ Nala is thinking<span class="loading-dots"></span>', 'system-line');
      
      setTimeout(() => {
        const result = nlp.processCommand(command, {
          currentUser: currentUser,
          activePatterns: Array.from(activePatterns.keys())
        });
        
        handleNLPResult(result, command);
      }, 800);
    }
    
    function handleNLPResult(result, originalCommand) {
      // Remove thinking indicator
      const lines = document.querySelectorAll('.terminal-line');
      const lastLine = lines[lines.length - 1];
      if (lastLine && lastLine.textContent.includes('thinking')) {
        lastLine.remove();
      }
      
      switch (result.type) {
        case 'create_music':
          createMusic(result);
          break;
          
        case 'community':
          showCommunityFeed();
          break;
          
        case 'profile':
          showProfile();
          break;
          
        case 'social':
          showSocial();
          break;
          
        case 'pattern_control':
          handlePatternControl(result);
          break;
          
        case 'learning':
          handleLearning(result);
          break;
          
        case 'sentiment':
          addLine(result.response, 'success-line');
          break;
          
        case 'unknown':
        default:
          handleUnknownCommand(result, originalCommand);
          break;
      }
    }
    
    // Music creation
    function createMusic(result) {
      const genre = result.genre || 'lo-fi';
      const mood = result.mood || null;
      const tempo = result.tempo || null;
      
      addLine(`ğŸµ Generating ${genre} pattern${mood ? ` for ${mood}` : ''}...`, 'system-line');
      
      setTimeout(() => {
        const pattern = generateStrudelPattern(genre, mood, tempo);
        const patternId = generatePatternId();
        
        addLine(`ğŸ¼ Created: ${pattern.description}`, 'success-line');
        addLine('', 'output-line');
        
        // Display inline Strudel player
        addStrudelPlayer(pattern.code, pattern.description, patternId);
        activePatterns.set(patternId, pattern);
        
        addLine('', 'output-line');
        addLine('ğŸµ Use: "play this", "save this pattern", "share this beat"', 'dim-line');
        
        // Update NLP context
        nlp.setCurrentPattern(patternId);
        
      }, 1500);
    }
    
    function generateMusicFromOnboarding(command) {
      // Special version for onboarding - simpler flow
      const result = nlp.processCommand(command);
      if (result.type === 'create_music') {
        createMusic(result);
      } else {
        // Fallback to simple pattern
        const pattern = generateStrudelPattern('lo-fi');
        const patternId = generatePatternId();
        addStrudelPlayer(pattern.code, pattern.description, patternId);
        activePatterns.set(patternId, pattern);
      }
    }
    
    // Community features
    function showCommunityFeed() {
      addLine('ğŸŒ Loading community feed...', 'system-line');
      
      setTimeout(() => {
        addLine('', 'output-line');
        addLine('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'dim-line');
        addLine('ğŸŒ COMMUNITY FEED - Recent Patterns', 'highlight-line');
        addLine('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'dim-line');
        addLine('', 'output-line');
        
        const feedData = [
          { user: 'Alex Chen', genre: 'trap', title: 'Midnight Vibes', time: '2h ago', likes: 23, id: 'pat_001' },
          { user: 'Jordan UK', genre: 'drill', title: 'UK Energy', time: '4h ago', likes: 41, id: 'pat_002' },
          { user: 'Kemi Lagos', genre: 'afrobeats', title: 'Lagos Groove', time: '6h ago', likes: 67, id: 'pat_003' },
          { user: 'Neon Rider', genre: 'synthwave', title: 'Retro Dreams', time: '8h ago', likes: 89, id: 'pat_004' }
        ];
        
        // Create table
        const tableHTML = `
          <table class="terminal-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Title</th>
                <th>Artist</th>
                <th>Genre</th>
                <th>Time</th>
                <th>Likes</th>
              </tr>
            </thead>
            <tbody>
              ${feedData.map((item, index) => `
                <tr>
                  <td>${index + 1}</td>
                  <td>ğŸµ ${item.title}</td>
                  <td>${item.user}</td>
                  <td>${item.genre}</td>
                  <td>${item.time}</td>
                  <td>â¤ï¸ ${item.likes}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
        
        addHTML(tableHTML);
        
        addLine('', 'output-line');
        addLine('ğŸ’¡ Commands: "play pattern 1", "like pattern 2", "show trending"', 'info-line');
        addLine('ğŸ”„ Updates automatically every 30 seconds', 'dim-line');
        
      }, 1000);
    }
    
    function showProfile() {
      if (!currentUser) {
        addLine('âŒ Please login to view your profile', 'error-line');
        addLine('ğŸ’¡ Type "login" to access your account', 'info-line');
        return;
      }
      
      addLine('ğŸ‘¤ Loading your profile...', 'system-line');
      
      setTimeout(() => {
        addLine('', 'output-line');
        addLine('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'dim-line');
        addLine(`ğŸ‘¤ ${currentUser.firstName || currentUser.email.split('@')[0]}'s Profile`, 'highlight-line');
        addLine('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'dim-line');
        addLine('', 'output-line');
        
        addLine(`ğŸ“§ Email: ${currentUser.email}`, 'output-line');
        addLine(`ğŸ­ Role: ${currentUser.role}`, 'output-line');
        addLine(`ğŸ“… Member since: ${new Date().toLocaleDateString()}`, 'output-line');
        addLine('', 'output-line');
        
        // Stats table
        const statsHTML = `
          <table class="terminal-table">
            <thead>
              <tr><th>Metric</th><th>Value</th></tr>
            </thead>
            <tbody>
              <tr><td>ğŸµ Patterns created</td><td>7</td></tr>
              <tr><td>â¤ï¸ Likes received</td><td>42</td></tr>
              <tr><td>ğŸ‘¥ Followers</td><td>12</td></tr>
              <tr><td>ğŸ”— Following</td><td>8</td></tr>
            </tbody>
          </table>
        `;
        
        addHTML(statsHTML);
        
        addLine('', 'output-line');
        addLine('ğŸ’¡ Commands: "edit profile", "show my patterns", "analytics"', 'info-line');
        
      }, 800);
    }
    
    function showSocial() {
      addLine('ğŸ‘¥ Loading social overview...', 'system-line');
      
      setTimeout(() => {
        addLine('', 'output-line');
        addLine('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'dim-line');
        addLine('ğŸ‘¥ SOCIAL - Who\'s Creating', 'highlight-line');
        addLine('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'dim-line');
        addLine('', 'output-line');
        
        addLine('ğŸŸ¢ ONLINE NOW (4 creators):', 'success-line');
        addLine('  ğŸ¹ Alex Chen - Creating trap beats', 'output-line');
        addLine('  ğŸ¥ Jordan UK - Working on drill patterns', 'output-line');
        addLine('  ğŸŒ Kemi Lagos - Mixing afrobeats', 'output-line');
        addLine('  ğŸŒ† Neon Rider - Synthesizing retro vibes', 'output-line');
        addLine('', 'output-line');
        
        addLine('ğŸ“ˆ TRENDING CREATORS:', 'info-line');
        addLine('  1. BeatMaster3000 - 127 patterns this month', 'output-line');
        addLine('  2. LoFiQueen - 98 chill beats', 'output-line');
        addLine('  3. DrillSergeant - 76 UK drill hits', 'output-line');
        addLine('', 'output-line');
        
        addLine('ğŸ’¡ Commands: "follow BeatMaster3000", "message Alex Chen"', 'info-line');
        
      }, 1200);
    }
    
    // Pattern control
    function handlePatternControl(result) {
      const action = result.action;
      const target = result.target;
      
      let patternId = null;
      
      if (target === 'current' || target === 'this' || target === 'that') {
        // Use the last created pattern
        const patterns = Array.from(activePatterns.keys());
        patternId = patterns[patterns.length - 1];
      } else if (target.match(/^\d+$/)) {
        // Pattern number from feed/list
        addLine(`ğŸµ Pattern ${target} from community feed`, 'info-line');
        return;
      }
      
      if (!patternId) {
        addLine('âŒ No pattern to control. Create one first!', 'error-line');
        return;
      }
      
      switch (action) {
        case 'play':
          playPattern(patternId);
          break;
        case 'stop':
          stopPattern(patternId);
          break;
        case 'save':
          savePattern(patternId);
          break;
        case 'share':
          sharePattern(patternId);
          break;
        case 'edit':
          addLine(`âœï¸ Edit mode for pattern ${patternId}`, 'info-line');
          addLine('ğŸ’¡ Click in the code area above to edit', 'dim-line');
          break;
      }
    }
    
    // Learning system
    function handleLearning(result) {
      const topic = result.topic;
      const knowledge = result.knowledge;
      
      if (knowledge) {
        addLine(`ğŸ“ ${topic.toUpperCase()}:`, 'success-line');
        addLine('', 'output-line');
        
        if (knowledge.type === 'genre') {
          const genre = knowledge.data;
          addLine(`ğŸ“ ${genre.description}`, 'output-line');
          addLine('', 'output-line');
          addLine(`ğŸµ Characteristics: ${genre.characteristics.join(', ')}`, 'output-line');
          addLine(`â±ï¸ Typical BPM: ${genre.bpm}`, 'output-line');
          addLine(`ğŸŒ Origins: ${genre.origins}`, 'output-line');
        } else if (knowledge.type === 'concept') {
          addLine(`ğŸ“ ${knowledge.description}`, 'output-line');
        }
        
        addLine('', 'output-line');
        addLine(`ğŸ’¡ Want to try creating ${topic}? Say "create ${topic} music"`, 'info-line');
      } else {
        addLine(`ğŸ¤” I don't have detailed info about "${topic}" yet.`, 'output-line');
        addLine('ğŸ’¡ Try asking about: trap, drill, lo-fi, house, jazz, afrobeats', 'dim-line');
      }
    }
    
    function handleUnknownCommand(result, originalCommand) {
      addLine(`ğŸ¤” I'm not sure what you mean by "${originalCommand}"`, 'output-line');
      addLine('', 'output-line');
      
      if (result.suggestions && result.suggestions.length > 0) {
        addLine('ğŸ’¡ Did you mean:', 'info-line');
        result.suggestions.forEach(suggestion => {
          addLine(`  "${suggestion}"`, 'dim-line');
        });
      } else {
        addLine('ğŸ’¡ Try these examples:', 'info-line');
        addLine('  "create trap beat"', 'dim-line');
        addLine('  "show community feed"', 'dim-line');
        addLine('  "help"', 'dim-line');
      }
    }
    
    // Strudel player functions
    function addStrudelPlayer(code, description, patternId) {
      const playerHTML = `
        <div class="inline-strudel-player" id="${patternId}">
          <div class="player-header">
            <span>ğŸµ ${description}</span>
            <span class="pattern-id" onclick="copyPatternId('${patternId}')" title="Click to copy pattern ID">${patternId}</span>
          </div>
          <textarea class="strudel-code" id="${patternId}-code">${code}</textarea>
          <div class="player-controls">
            <button class="control-btn btn-play" onclick="playPattern('${patternId}')">â–¶ Play</button>
            <button class="control-btn btn-stop" onclick="stopPattern('${patternId}')" disabled>â¹ Stop</button>
            <button class="control-btn btn-save" onclick="savePattern('${patternId}')">ğŸ’¾ Save</button>
            <button class="control-btn btn-share" onclick="sharePattern('${patternId}')">ğŸ“¤ Share</button>
          </div>
        </div>
      `;
      
      addHTML(playerHTML);
    }
    
    function playPattern(patternId) {
      addLine(`ğŸ”Š Playing pattern ${patternId}...`, 'success-line');
      
      // Update button states
      const playBtn = document.querySelector(`#${patternId} .btn-play`);
      const stopBtn = document.querySelector(`#${patternId} .btn-stop`);
      
      if (playBtn) {
        playBtn.textContent = 'â¸ Pause';
        playBtn.classList.add('playing');
      }
      if (stopBtn) {
        stopBtn.disabled = false;
      }
      
      // Initialize audio if needed
      if (!isAudioInitialized) {
        initAudio();
      }
    }
    
    function stopPattern(patternId) {
      addLine(`â¹ Stopped pattern ${patternId}`, 'system-line');
      
      // Update button states
      const playBtn = document.querySelector(`#${patternId} .btn-play`);
      const stopBtn = document.querySelector(`#${patternId} .btn-stop`);
      
      if (playBtn) {
        playBtn.textContent = 'â–¶ Play';
        playBtn.classList.remove('playing');
      }
      if (stopBtn) {
        stopBtn.disabled = true;
      }
    }
    
    function savePattern(patternId) {
      if (!currentUser) {
        addLine('âŒ Please login to save patterns', 'error-line');
        addLine('ğŸ’¡ Type "login" to access your account', 'info-line');
        return;
      }
      
      addLine(`ğŸ’¾ Saving pattern ${patternId}...`, 'system-line');
      
      setTimeout(() => {
        addLine(`âœ… Pattern saved to your library!`, 'success-line');
        
        // Update button state
        const saveBtn = document.querySelector(`#${patternId} .btn-save`);
        if (saveBtn) {
          saveBtn.textContent = 'âœ… Saved';
          saveBtn.classList.add('saved');
          saveBtn.disabled = true;
        }
      }, 1000);
    }
    
    function sharePattern(patternId) {
      const url = `${window.location.origin}/pattern/${patternId}`;
      
      if (navigator.clipboard) {
        navigator.clipboard.writeText(url).then(() => {
          addLine(`ğŸ“¤ Pattern link copied: ${url}`, 'success-line');
          addLine('ğŸ’¡ Share on social media or send to friends!', 'dim-line');
        });
      } else {
        addLine(`ğŸ“¤ Share link: ${url}`, 'success-line');
      }
    }
    
    function copyPatternId(patternId) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(patternId).then(() => {
          addLine(`ğŸ“‹ Pattern ID copied: ${patternId}`, 'system-line');
        });
      }
    }
    
    // Pattern generation
    function generateStrudelPattern(genre, mood, tempo) {
      const patterns = {
        'trap': {
          code: 'stack(\n  sound("bd*2 ~ bd ~").gain(0.8),\n  sound("~ ~ sd ~").gain(0.7),\n  sound("hh*8").gain(0.3),\n  sound("808").note("c2 c2 f1 c2").lpf(100)\n).slow(2)',
          description: 'Modern trap beat with 808s and crisp snares'
        },
        'drill': {
          code: 'stack(\n  sound("bd ~ bd bd").gain(0.9),\n  sound("~ ~ sd ~").gain(0.8),\n  sound("hh*16").gain(0.2),\n  sound("808*4").note("c1 ~ f1 g1").lpf(80)\n).slow(2)',
          description: 'UK drill pattern with sliding 808s'
        },
        'lo-fi': {
          code: 'stack(\n  sound("bd ~ sd ~").gain(0.6),\n  sound("hh*4").gain(0.2),\n  sound("vinyl").gain(0.1)\n).slow(2).room(0.3)',
          description: 'Chill lo-fi beat perfect for studying'
        },
        'house': {
          code: 'stack(\n  sound("bd bd bd bd"),\n  sound("~ hh ~ hh").gain(0.5),\n  sound("~ ~ sd ~").delay(0.05)\n).slow(2)',
          description: 'Classic house 4/4 pattern'
        },
        'jazz': {
          code: 'note("Cmaj7 Am7 Dm7 G7").sound("piano").slow(4).room(0.2)',
          description: 'Jazz chord progression with piano'
        },
        'afrobeats': {
          code: 'stack(\n  sound("bd ~ bd ~").gain(0.8),\n  sound("~ sd ~ sd").gain(0.6),\n  sound("perc*8").gain(0.4),\n  note("c4 eb4 f4 g4").sound("kalimba").slow(4)\n).slow(2)',
          description: 'Afrobeats rhythm with polyrhythmic percussion'
        },
        'synthwave': {
          code: 'stack(\n  sound("bd ~ ~ ~").gain(0.8),\n  sound("~ ~ sd ~").gain(0.6),\n  note("c4 eb4 f4 ab4").sound("sawtooth").slow(8).lpf(1200)\n).slow(2)',
          description: 'Retro synthwave with nostalgic leads'
        }
      };
      
      let pattern = patterns[genre] || patterns['lo-fi'];
      
      // Modify description based on mood and tempo
      if (mood) {
        pattern = {
          ...pattern,
          description: `${pattern.description} - perfect for ${mood}`
        };
      }
      
      if (tempo) {
        pattern = {
          ...pattern,
          description: `${pattern.description} at ${tempo} BPM`
        };
      }
      
      return pattern;
    }
    
    function generatePatternId() {
      return 'pat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
    }
    
    // Voice input
    function setupVoiceInput() {
      const voiceBtn = document.getElementById('voiceBtn');
      
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        voiceRecognition = new SpeechRecognition();
        
        voiceRecognition.continuous = false;
        voiceRecognition.interimResults = false;
        voiceRecognition.lang = 'en-US';
        
        voiceRecognition.onresult = function(event) {
          const transcript = event.results[0][0].transcript;
          document.getElementById('terminalInput').value = transcript;
          addLine(`ğŸ¤ Voice: "${transcript}"`, 'info-line');
          executeCommand(transcript);
          stopListening();
        };
        
        voiceRecognition.onerror = function(event) {
          addLine(`âŒ Voice recognition error: ${event.error}`, 'error-line');
          stopListening();
        };
        
        voiceRecognition.onend = function() {
          stopListening();
        };
        
        voiceBtn.addEventListener('click', toggleVoiceInput);
      } else {
        voiceBtn.style.display = 'none';
      }
    }
    
    function toggleVoiceInput() {
      if (isListening) {
        stopListening();
      } else {
        startVoiceInput();
      }
    }
    
    function startVoiceInput() {
      if (voiceRecognition && !isListening) {
        isListening = true;
        const voiceBtn = document.getElementById('voiceBtn');
        voiceBtn.classList.add('listening');
        voiceBtn.textContent = 'ğŸ”´';
        
        addLine('ğŸ¤ Listening... Speak your command', 'system-line');
        voiceRecognition.start();
      }
    }
    
    function stopListening() {
      if (isListening) {
        isListening = false;
        const voiceBtn = document.getElementById('voiceBtn');
        voiceBtn.classList.remove('listening');
        voiceBtn.textContent = 'ğŸ¤';
        
        if (voiceRecognition) {
          voiceRecognition.stop();
        }
      }
    }
    
    // Utility functions
    function addLine(text, className = 'output-line') {
      const line = document.createElement('div');
      line.className = `terminal-line ${className}`;
      line.innerHTML = text; // Use innerHTML to support HTML entities
      document.getElementById('terminalContent').appendChild(line);
      
      setTimeout(scrollToBottom, 10);
    }
    
    function addHTML(htmlContent) {
      const div = document.createElement('div');
      div.innerHTML = htmlContent;
      document.getElementById('terminalContent').appendChild(div);
      setTimeout(scrollToBottom, 10);
    }
    
    function clearTerminal() {
      document.getElementById('terminalContent').innerHTML = '';
      addLine('Terminal cleared.', 'system-line');
      addLine('ğŸ’¡ Type "help" for available commands', 'dim-line');
    }
    
    function scrollToBottom() {
      const content = document.getElementById('terminalContent');
      content.scrollTop = content.scrollHeight;
    }
    
    function getCurrentPrompt() {
      return currentUser ? `${currentUser.email.split('@')[0]}@nal:~$` : 'nal@music:~$';
    }
    
    function updatePrompt() {
      document.getElementById('terminalPrompt').textContent = getCurrentPrompt();
    }
    
    // Help system
    function showHelp() {
      addLine('', 'output-line');
      addLine('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'dim-line');
      addLine('ğŸµ NOT A LABEL TERMINAL - Command Guide', 'highlight-line');
      addLine('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'dim-line');
      addLine('', 'output-line');
      
      addLine('ğŸµ MUSIC CREATION (Natural Language):', 'success-line');
      addLine('  "create trap beat"                   - Generate trap pattern', 'output-line');
      addLine('  "make lo-fi music for studying"      - Create chill beats', 'output-line');
      addLine('  "generate drill pattern"             - UK drill sounds', 'output-line');
      addLine('  "hey nala create jazz chords"        - Jazz progressions', 'output-line');
      addLine('  "create something energetic"         - Context-aware generation', 'output-line');
      addLine('', 'output-line');
      
      addLine('ğŸŒ COMMUNITY & SOCIAL:', 'success-line');
      addLine('  "show community feed"                - Recent patterns', 'output-line');
      addLine('  "what\'s trending"                   - Popular content', 'output-line');
      addLine('  "who\'s online"                      - Active creators', 'output-line');
      addLine('  "recent patterns"                    - Latest creations', 'output-line');
      addLine('', 'output-line');
      
      addLine('ğŸ¼ PATTERN INTERACTION:', 'success-line');
      addLine('  "play this pattern"                  - Play current pattern', 'output-line');
      addLine('  "save this beat"                     - Save to library', 'output-line');
      addLine('  "share this music"                   - Get share link', 'output-line');
      addLine('  "make it faster"                     - Modify current pattern', 'output-line');
      addLine('', 'output-line');
      
      addLine('ğŸ‘¤ PROFILE & ACCOUNT:', 'success-line');
      addLine('  "my profile"                         - View your profile', 'output-line');
      addLine('  "my patterns"                        - Your creations', 'output-line');
      addLine('  "login" / "register"                 - Account access', 'output-line');
      addLine('', 'output-line');
      
      addLine('ğŸ“ LEARNING & HELP:', 'success-line');
      addLine('  "what is trap music"                 - Learn about genres', 'output-line');
      addLine('  "explain polyrhythm"                 - Music theory', 'output-line');
      addLine('  "tutorial"                           - Interactive walkthrough', 'output-line');
      addLine('', 'output-line');
      
      addLine('ğŸ› ï¸ SYSTEM COMMANDS:', 'success-line');
      addLine('  help                                 - Show this guide', 'output-line');
      addLine('  clear                                - Clear terminal', 'output-line');
      addLine('  ğŸ¤                                   - Voice input button', 'output-line');
      addLine('', 'output-line');
      
      addLine('ğŸ’¡ PRO TIPS:', 'info-line');
      addLine('  â€¢ Use natural language: "create something chill"', 'dim-line');
      addLine('  â€¢ Context aware: "play it", "save this", "make it darker"', 'dim-line');
      addLine('  â€¢ Arrow keys navigate command history', 'dim-line');
      addLine('  â€¢ Tab completes suggestions', 'dim-line');
      addLine('  â€¢ Works offline with cached patterns', 'dim-line');
      addLine('  â€¢ Voice input available on mobile', 'dim-line');
      addLine('', 'output-line');
    }
    
    // Quick commands
    function executeQuickCommand(quickType) {
      const commands = {
        'trap': 'create trap beat',
        'lofi': 'create lo-fi music for studying',
        'drill': 'create drill beat',
        'house': 'create house music'
      };
      
      const command = commands[quickType];
      if (command) {
        addLine(`ğŸš€ Quick command: ${command}`, 'info-line');
        setTimeout(() => executeCommand(command), 500);
      }
    }
    
    // Session management
    function checkExistingSession() {
      const savedUser = localStorage.getItem('user');
      if (savedUser) {
        try {
          currentUser = JSON.parse(savedUser);
          updatePrompt();
          addLine(`ğŸ‘‹ Welcome back, ${currentUser.firstName || currentUser.email.split('@')[0]}!`, 'success-line');
        } catch (error) {
          console.error('Session restore error:', error);
        }
      }
    }
    
    function showLogin() {
      addLine('ğŸ” Login functionality coming soon!', 'info-line');
      addLine('ğŸ’¡ For now, enjoy the terminal in guest mode', 'dim-line');
      addLine('ğŸµ All music creation features are available!', 'success-line');
    }
    
    function showRegister() {
      addLine('ğŸ“ Registration coming soon!', 'info-line');
      addLine('ğŸ’¡ Create patterns as a guest and save them later', 'dim-line');
    }
    
    function showUserMenu() {
      if (currentUser) {
        addLine(`ğŸ‘¤ ${currentUser.firstName || currentUser.email.split('@')[0]} Menu:`, 'info-line');
        addLine('  "my profile" - View profile and stats', 'dim-line');
        addLine('  "my patterns" - Your saved patterns', 'dim-line');
        addLine('  "logout" - Sign out', 'dim-line');
      } else {
        addLine('ğŸ‘¤ Guest Menu:', 'info-line');
        addLine('  "login" - Access your account', 'dim-line');
        addLine('  "register" - Create new account', 'dim-line');
      }
    }
    
    // PWA setup
    function setupPWA() {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('SW registered:', registration);
            addLine('ğŸ“± PWA features active', 'system-line');
          })
          .catch(error => {
            console.log('SW registration failed:', error);
          });
      }
      
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        showPWAInstallBanner();
      });
      
      if (window.matchMedia('(display-mode: standalone)').matches) {
        addLine('ğŸ“± Running as installed PWA', 'system-line');
      }
    }
    
    function showPWAInstallBanner() {
      const banner = document.getElementById('pwaInstallBanner');
      banner.classList.add('show');
      
      banner.addEventListener('click', async () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          
          if (outcome === 'accepted') {
            addLine('ğŸ“± Terminal installed successfully!', 'success-line');
          }
          
          deferredPrompt = null;
          banner.classList.remove('show');
        }
      });
      
      setTimeout(() => {
        banner.classList.remove('show');
      }, 10000);
    }
    
    // Network monitoring
    function setupNetworkMonitoring() {
      function updateNetworkStatus() {
        const dot = document.getElementById('networkDot');
        const text = document.getElementById('networkText');
        
        if (navigator.onLine) {
          dot.classList.remove('offline');
          text.textContent = 'online';
          if (isOffline) {
            addLine('ğŸŒ Back online - all features restored', 'success-line');
            isOffline = false;
          }
        } else {
          dot.classList.add('offline');
          text.textContent = 'offline';
          if (!isOffline) {
            addLine('ğŸ“¡ Offline mode - cached patterns available', 'info-line');
            isOffline = true;
          }
        }
      }
      
      window.addEventListener('online', updateNetworkStatus);
      window.addEventListener('offline', updateNetworkStatus);
      updateNetworkStatus();
    }
    
    // Audio setup
    function setupAudio() {
      document.addEventListener('click', initAudio, { once: true });
    }
    
    async function initAudio() {
      if (!isAudioInitialized) {
        try {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
          if (audioContext.state === 'suspended') {
            await audioContext.resume();
          }
          isAudioInitialized = true;
          addLine('ğŸ”Š Audio engine ready', 'system-line');
        } catch (error) {
          console.error('Audio init error:', error);
        }
      }
    }
    
    // Clock
    function startClock() {
      function updateClock() {
        const now = new Date();
        const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        document.getElementById('timeStatus').textContent = timeString;
      }
      
      updateClock();
      setInterval(updateClock, 1000);
    }
    
    // Make functions globally available
    window.playPattern = playPattern;
    window.stopPattern = stopPattern;
    window.savePattern = savePattern;
    window.sharePattern = sharePattern;
    window.copyPatternId = copyPatternId;
    window.showUserMenu = showUserMenu;
  </script>
</body>
</html>