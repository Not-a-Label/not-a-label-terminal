<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Not a Label - AI Music Terminal</title>
  
  <!-- PWA Meta Tags -->
  <meta name="description" content="AI-powered music creation terminal. Create, share, and collaborate through natural language commands.">
  <meta name="theme-color" content="#00ff00">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Not a Label Terminal">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  
  <style>
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box;
    }
    
    body { 
      background: #000; 
      color: #00ff00; 
      font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
      overflow: hidden;
      height: 100vh;
      position: fixed;
      width: 100%;
    }
    
    .terminal {
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .terminal-header {
      background: linear-gradient(135deg, #111, #001100);
      border-bottom: 1px solid #00ff0055;
      padding: 8px 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      min-height: 45px;
      flex-shrink: 0;
    }
    
    .terminal-title {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #00ff00;
      font-size: 14px;
      font-weight: bold;
    }
    
    .terminal-content {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      scroll-behavior: smooth;
    }
    
    .terminal-line {
      margin: 2px 0;
      line-height: 1.4;
      font-size: 13px;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    
    .system-line { color: #00ffff; }
    .error-line { color: #ff0066; font-weight: bold; }
    .input-line { color: #00ff00; font-weight: bold; }
    .output-line { color: #cccccc; }
    .success-line { color: #00ff88; font-weight: bold; }
    .info-line { color: #ffaa00; }
    .highlight-line { 
      color: #00ff00; 
      background: rgba(0, 255, 0, 0.1);
      padding: 4px 8px;
      border-left: 3px solid #00ff00;
      margin: 4px 0;
      border-radius: 0 4px 4px 0;
    }
    
    .terminal-input-container {
      background: linear-gradient(135deg, #111, #001100);
      border-top: 1px solid #00ff0055;
      padding: 12px 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }
    
    .terminal-prompt {
      color: #00ff00;
      font-weight: bold;
      white-space: nowrap;
      user-select: none;
      min-width: fit-content;
    }
    
    .terminal-input {
      background: transparent;
      border: none;
      color: #00ff00;
      font-family: inherit;
      font-size: 13px;
      outline: none;
      padding: 6px 0;
      width: 100%;
      flex: 1;
    }
    
    .terminal-input::placeholder {
      color: #00ff0055;
      font-style: italic;
    }
    
    /* Community table styling */
    .terminal-line table {
      color: #00ff00;
      border-collapse: collapse;
      width: 100%;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
    
    .terminal-line table th {
      color: #00ffff;
      border-bottom: 1px solid #00ff0055;
      text-align: left;
      padding: 6px;
      font-weight: bold;
    }
    
    .terminal-line table td {
      border-bottom: 1px solid #00ff0022;
      padding: 6px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .terminal-line table tr:hover {
      background-color: rgba(0, 255, 0, 0.05);
    }
    
    .dim-line {
      color: #666;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="terminal">
    <div class="terminal-header">
      <div class="terminal-title">
        <span>üéµ NOT A LABEL TERMINAL</span>
      </div>
    </div>
    
    <div class="terminal-content" id="terminalContent">
      <div class="terminal-line system-line">[SYSTEM] ‚úÖ AI Music Generation Engine Active</div>
      <div class="terminal-line system-line">[SYSTEM] ‚úÖ Community System Online</div>
      <div class="terminal-line system-line">[SYSTEM] ‚úÖ Pattern Sharing Enabled</div>
      <div class="terminal-line system-line"></div>
      <div class="terminal-line highlight-line">üéµ Welcome to Not a Label - Where Music Meets AI</div>
      <div class="terminal-line output-line">Create, share, and discover music through natural language.</div>
      <div class="terminal-line output-line"></div>
      <div class="terminal-line success-line">‚ú® NEW: Create your musical identity - no boring signups!</div>
      <div class="terminal-line info-line">üéØ Quick Start: "create trap beat" or "create musical identity"</div>
      <div class="terminal-line dim-line">üí° Type "help" to see all features</div>
      <div class="terminal-line system-line"></div>
    </div>
    
    <div class="terminal-input-container">
      <span class="terminal-prompt" id="terminalPrompt">nal@music:~$</span>
      <input type="text" class="terminal-input" id="terminalInput" 
             placeholder="Type any command and press Enter..." 
             autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    </div>
  </div>

  <!-- Simple Web Audio for immediate sound feedback -->
  <script>
    // Initialize simple audio system that always works
    window.audioReady = false;
    window.audioContext = null;
    
    function initSimpleAudio() {
      try {
        window.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        window.audioReady = true;
        console.log('‚úÖ Simple audio system ready');
        
        // Test sound on first click
        if (window.addLine) {
          window.addLine('üîä Audio system ready - click PLAY to hear patterns!', 'success-line');
        }
      } catch (err) {
        console.error('Audio initialization failed:', err);
      }
    }
    
    // Initialize audio on first user interaction
    document.addEventListener('click', function initAudioOnClick() {
      if (!window.audioReady) {
        initSimpleAudio();
        document.removeEventListener('click', initAudioOnClick);
      }
    }, { once: true });
  </script>
  
  <!-- Load AI Components -->
  <script src="/js/ai-integration.js?v=1749313000"></script>
  <script src="/js/nlp.js?v=1749313000"></script>
  <script src="/js/enhanced-pattern-generator.js?v=1749313000"></script>
  <script src="/js/musical-identity-creator.js?v=1749313000"></script>
  <script src="/js/community.js?v=1749313000"></script>
  <script src="/js/pattern-sharing.js?v=1749313000"></script>
  
  <script>
    console.log('üöÄ Not a Label Terminal loading v2.1.1 - DeepSeek R1 AI Integration...');
    
    // Initialize AI components
    let nalaAI, nlp, patternGenerator, musicalIdentityCreator, communitySystem, patternSharingSystem;
    let currentPattern = null;
    let audioContext = null;
    let currentUser = null;
    
    function addLine(text, className = 'output-line') {
      const line = document.createElement('div');
      line.className = `terminal-line ${className}`;
      line.textContent = text;
      document.getElementById('terminalContent').appendChild(line);
      
      setTimeout(() => {
        const content = document.getElementById('terminalContent');
        content.scrollTop = content.scrollHeight;
      }, 10);
    }
    
    function addHTML(html, className = 'output-line') {
      const line = document.createElement('div');
      line.className = `terminal-line ${className}`;
      line.innerHTML = html;
      document.getElementById('terminalContent').appendChild(line);
      
      setTimeout(() => {
        const content = document.getElementById('terminalContent');
        content.scrollTop = content.scrollHeight;
      }, 10);
    }
    
    async function generateMusic(command) {
      try {
        addLine('ü§ñ Nala AI (DeepSeek R1) analyzing your request...', 'info-line');
        
        // Process with NLP for context
        const nlpResult = nlp.processCommand(command);
        console.log('NLP Result:', nlpResult);
        
        if (nlpResult.type === 'create_music') {
          addLine(`üéµ AI generating ${nlpResult.genre} music...`, 'success-line');
          
          // Use Nala AI (DeepSeek R1) for generation
          const musicDNA = {
            primaryGenre: nlpResult.genre,
            preferredMood: nlpResult.mood,
            energyLevel: Math.round((nlpResult.tempo || 120) / 20),
            complexity: 5
          };
          
          const context = {
            timeOfDay: getTimeOfDay(),
            activity: extractActivity(command),
            userAgent: navigator.userAgent
          };
          
          console.log('ü§ñ Calling Nala AI with:', { command, musicDNA, context });
          const result = await nalaAI.generateMusic(command, musicDNA, context);
          console.log('ü§ñ Nala AI result:', result);
          currentPattern = result;
          
          addLine('', 'output-line');
          addLine('üéº STRUDEL PATTERN GENERATED:', 'success-line');
          addLine('', 'output-line');
          
          // Display the Strudel code with syntax highlighting
          const codeDisplay = document.createElement('div');
          codeDisplay.className = 'terminal-line';
          codeDisplay.style.cssText = `
            background: rgba(0, 255, 0, 0.05);
            border: 1px solid #00ff0033;
            border-radius: 4px;
            padding: 12px;
            margin: 8px 0;
            font-family: 'Courier New', monospace;
            color: #00ff88;
            overflow-x: auto;
            white-space: pre;
          `;
          codeDisplay.textContent = result.code;
          document.getElementById('terminalContent').appendChild(codeDisplay);
          
          addLine('', 'output-line');
          addLine(`üìù ${result.description}`, 'info-line');
          addLine('', 'output-line');
          
          // Add playback controls with unique IDs
          const patternId = `pattern_${Date.now()}`;
          const controlsHTML = `
            <div style="display: flex; gap: 10px; align-items: center; margin: 10px 0;">
              <button id="playBtn_${patternId}" style="background: #00ff00; color: #000; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold;">
                ‚ñ∂Ô∏è PLAY
              </button>
              <button id="stopBtn_${patternId}" style="background: #ff0066; color: #fff; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold;">
                ‚èπÔ∏è STOP
              </button>
              <button id="saveBtn_${patternId}" style="background: #0066ff; color: #fff; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold;">
                üíæ SAVE
              </button>
            </div>
          `;
          addHTML(controlsHTML);
          
          // Add event listeners for controls with unique IDs
          setTimeout(() => {
            const playBtn = document.getElementById(`playBtn_${patternId}`);
            const stopBtn = document.getElementById(`stopBtn_${patternId}`);
            const saveBtn = document.getElementById(`saveBtn_${patternId}`);
            
            console.log('üéõÔ∏è Adding event listeners for pattern:', patternId);
            
            if (playBtn) {
              playBtn.addEventListener('click', () => {
                console.log('üéµ Play button clicked for pattern:', patternId);
                playPattern(result.code);
              });
              console.log('‚úÖ Play button listener added');
            } else {
              console.error('‚ùå Play button not found:', `playBtn_${patternId}`);
            }
            
            if (stopBtn) {
              stopBtn.addEventListener('click', stopPattern);
              console.log('‚úÖ Stop button listener added');
            }
            
            if (saveBtn) {
              saveBtn.addEventListener('click', () => savePattern(result));
              console.log('‚úÖ Save button listener added');
            }
          }, 100);
          
          addLine('üéØ Pattern ready! Use controls above to play, stop, or save.', 'success-line');
          
        } else if (nlpResult.type === 'sentiment') {
          addLine(nlpResult.response, 'success-line');
        } else {
          addLine(`ü§î ${nlpResult.response || "I can help you create music! Try: 'create trap beat' or 'make lo-fi music'"}`, 'info-line');
        }
        
      } catch (error) {
        console.error('Music generation error:', error);
        addLine('‚ùå Error generating music. Please try again.', 'error-line');
      }
    }
    
    let currentPlayback = null;
    
    function playPattern(strudelCode) {
      console.log('üéµ playPattern called with:', strudelCode);
      addLine('üîä Playing pattern audio preview...', 'info-line');
      
      // Initialize audio if not ready
      if (!window.audioReady) {
        if (!window.audioContext) {
          try {
            console.log('üéµ Creating audio context...');
            window.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            window.audioReady = true;
            console.log('üéµ Audio context created:', window.audioContext.state);
          } catch (err) {
            console.error('üéµ Audio context creation failed:', err);
            addLine('‚ùå Audio not available in this browser', 'error-line');
            return;
          }
        } else {
          console.log('üéµ Audio context already exists:', window.audioContext.state);
        }
      }
      
      // Stop any current playback
      if (currentPlayback) {
        clearTimeout(currentPlayback);
      }
      
      // Extract notes from the pattern
      const noteMatches = strudelCode.match(/note\("([^"]+)"\)/g) || [];
      let notes = ['c4', 'e4', 'g4', 'c5']; // Default melody
      
      if (noteMatches.length > 0) {
        const noteString = noteMatches[0].match(/note\("([^"]+)"\)/)[1];
        notes = noteString.split(' ').filter(n => n !== '~' && n.length > 0);
      }
      
      // Determine genre for drum pattern
      const isDrums = strudelCode.includes('sound("bd') || strudelCode.includes('sound("hh') || strudelCode.includes('sound("sd');
      
      // Play the pattern
      try {
        console.log('üéµ Starting audio playback - isDrums:', isDrums, 'notes:', notes);
        if (isDrums) {
          playDrumPattern(strudelCode, notes);
        } else {
          playMelodyPattern(notes);
        }
        console.log('üéµ Audio playback started successfully');
        addLine('üéµ Audio preview playing! (4 beats)', 'success-line');
      } catch (err) {
        console.error('Playback error:', err);
        addLine('üéµ Generated pattern code (audio preview unavailable)', 'info-line');
      }
    }
    
    function playDrumPattern(strudelCode, melodyNotes) {
      const ctx = window.audioContext;
      console.log('ü•Å playDrumPattern - audioContext state:', ctx.state);
      
      // Resume audio context if suspended
      if (ctx.state === 'suspended') {
        console.log('üéµ Resuming suspended audio context...');
        ctx.resume().then(() => {
          console.log('üéµ Audio context resumed, starting drums');
          playDrumPatternInternal(ctx, strudelCode, melodyNotes);
        });
        return;
      }
      
      playDrumPatternInternal(ctx, strudelCode, melodyNotes);
    }
    
    function playDrumPatternInternal(ctx, strudelCode, melodyNotes) {
      const time = ctx.currentTime;
      
      // Create drum sounds using noise and oscillators
      const beatTimes = [0, 0.5, 1.0, 1.5]; // 4 beats
      
      beatTimes.forEach((beatTime, i) => {
        // Kick drum (low frequency)
        if (strudelCode.includes('bd') && (i === 0 || i === 2)) {
          const kickOsc = ctx.createOscillator();
          const kickGain = ctx.createGain();
          
          kickOsc.frequency.value = 60;
          kickOsc.type = 'sine';
          kickGain.gain.value = 0.3;
          
          kickOsc.connect(kickGain);
          kickGain.connect(ctx.destination);
          
          kickOsc.start(time + beatTime);
          kickGain.gain.exponentialRampToValueAtTime(0.001, time + beatTime + 0.1);
          kickOsc.stop(time + beatTime + 0.1);
        }
        
        // Snare drum (noise burst)
        if (strudelCode.includes('sd') && (i === 1 || i === 3)) {
          const noiseBuffer = ctx.createBuffer(1, ctx.sampleRate * 0.1, ctx.sampleRate);
          const noiseData = noiseBuffer.getChannelData(0);
          for (let j = 0; j < noiseData.length; j++) {
            noiseData[j] = Math.random() * 2 - 1;
          }
          
          const noiseSource = ctx.createBufferSource();
          const noiseGain = ctx.createGain();
          const noiseFilter = ctx.createBiquadFilter();
          
          noiseSource.buffer = noiseBuffer;
          noiseFilter.frequency.value = 1000;
          noiseGain.gain.value = 0.2;
          
          noiseSource.connect(noiseFilter);
          noiseFilter.connect(noiseGain);
          noiseGain.connect(ctx.destination);
          
          noiseSource.start(time + beatTime);
          noiseGain.gain.exponentialRampToValueAtTime(0.001, time + beatTime + 0.05);
        }
        
        // Hi-hat (high frequency noise)
        if (strudelCode.includes('hh')) {
          const hhOsc = ctx.createOscillator();
          const hhGain = ctx.createGain();
          const hhFilter = ctx.createBiquadFilter();
          
          hhOsc.frequency.value = 8000;
          hhOsc.type = 'square';
          hhFilter.frequency.value = 10000;
          hhGain.gain.value = 0.1;
          
          hhOsc.connect(hhFilter);
          hhFilter.connect(hhGain);
          hhGain.connect(ctx.destination);
          
          hhOsc.start(time + beatTime);
          hhGain.gain.exponentialRampToValueAtTime(0.001, time + beatTime + 0.02);
          hhOsc.stop(time + beatTime + 0.02);
        }
      });
      
      // Add melody on top if available
      if (melodyNotes.length > 0) {
        setTimeout(() => playMelodyPattern(melodyNotes), 100);
      }
    }
    
    function playMelodyPattern(notes) {
      const ctx = window.audioContext;
      console.log('üéπ playMelodyPattern - audioContext state:', ctx.state);
      
      // Resume audio context if suspended
      if (ctx.state === 'suspended') {
        console.log('üéµ Resuming suspended audio context...');
        ctx.resume().then(() => {
          console.log('üéµ Audio context resumed, starting melody');
          playMelodyPatternInternal(ctx, notes);
        });
        return;
      }
      
      playMelodyPatternInternal(ctx, notes);
    }
    
    function playMelodyPatternInternal(ctx, notes) {
      let time = ctx.currentTime;
      
      const noteFrequencies = {
        'c1': 32.70, 'c2': 65.41, 'c3': 130.81, 'c4': 261.63, 'c5': 523.25,
        'd1': 36.71, 'd2': 73.42, 'd3': 146.83, 'd4': 293.66, 'd5': 587.33,
        'e1': 41.20, 'e2': 82.41, 'e3': 164.81, 'e4': 329.63, 'e5': 659.25,
        'f1': 43.65, 'f2': 87.31, 'f3': 174.61, 'f4': 349.23, 'f5': 698.46,
        'g1': 49.00, 'g2': 98.00, 'g3': 196.00, 'g4': 392.00, 'g5': 783.99,
        'a1': 55.00, 'a2': 110.00, 'a3': 220.00, 'a4': 440.00, 'a5': 880.00,
        'b1': 61.74, 'b2': 123.47, 'b3': 246.94, 'b4': 493.88, 'b5': 987.77
      };
      
      notes.slice(0, 4).forEach((note, i) => {
        if (note && note !== '~') {
          const freq = noteFrequencies[note.toLowerCase()] || 261.63;
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          
          osc.frequency.value = freq;
          osc.type = 'sine';
          gain.gain.value = 0.15;
          
          osc.connect(gain);
          gain.connect(ctx.destination);
          
          const noteTime = time + i * 0.4;
          osc.start(noteTime);
          gain.gain.exponentialRampToValueAtTime(0.001, noteTime + 0.3);
          osc.stop(noteTime + 0.3);
        }
      });
    }
    
    function stopPattern() {
      try {
        console.log('‚èπÔ∏è stopPattern called');
        if (currentPlayback) {
          clearTimeout(currentPlayback);
          currentPlayback = null;
        }
        
        // Create a new audio context for next playback instead of suspending/resuming
        if (window.audioContext) {
          console.log('üéµ Current audio context state:', window.audioContext.state);
          // Don't suspend - just let current sounds finish naturally
          // Create fresh audio context for reliable next playback
          try {
            window.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            console.log('üéµ Created fresh audio context for next playback');
          } catch (err) {
            console.warn('üéµ Could not create fresh audio context:', err);
          }
        }
        
        addLine('‚èπÔ∏è Audio stopped.', 'success-line');
      } catch (error) {
        console.error('Stop error:', error);
        addLine('‚èπÔ∏è Playback stopped.', 'info-line');
      }
    }
    
    function savePattern(pattern) {
      if (patternSharingSystem) {
        patternSharingSystem.savePattern(pattern, `${pattern.metadata.genre}_${Date.now()}`);
      } else {
        addLine('üíæ Pattern saved to your library!', 'success-line');
        addLine(`üìÇ Saved as: "${pattern.metadata.genre}_${Date.now()}"`, 'output-line');
      }
    }
    
    function getTimeOfDay() {
      const hour = new Date().getHours();
      if (hour < 6) return 'night';
      if (hour < 12) return 'morning';
      if (hour < 18) return 'afternoon';
      if (hour < 22) return 'evening';
      return 'night';
    }
    
    function extractActivity(command) {
      const cmd = command.toLowerCase();
      if (cmd.includes('study') || cmd.includes('focus')) return 'studying';
      if (cmd.includes('workout') || cmd.includes('gym') || cmd.includes('exercise')) return 'working out';
      if (cmd.includes('party') || cmd.includes('dance') || cmd.includes('club')) return 'socializing';
      if (cmd.includes('create') || cmd.includes('art') || cmd.includes('creative')) return 'creating';
      return 'default';
    }
    
    function showUserProfile(user) {
      addLine('', 'output-line');
      addLine('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'success-line');
      addLine('üéµ YOUR MUSICAL PROFILE', 'highlight-line');
      addLine('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'success-line');
      addLine('', 'output-line');
      
      addLine(`üé® Artist Name: ${user.artistName}`, 'info-line');
      addLine(`üéº Primary Genre: ${user.musicDNA?.primaryGenre || 'Not set'}`, 'output-line');
      addLine(`üé≠ Preferred Mood: ${user.musicDNA?.preferredMood || 'Not set'}`, 'output-line');
      addLine(`‚ö° Energy Level: ${user.musicDNA?.energyLevel || 'Not set'}/10`, 'output-line');
      addLine(`üß© Complexity: ${user.musicDNA?.complexity || 'Not set'}/10`, 'output-line');
      
      if (user.musicDNA?.keywords && user.musicDNA.keywords.length > 0) {
        addLine(`üè∑Ô∏è Style Keywords: ${user.musicDNA.keywords.join(', ')}`, 'output-line');
      }
      
      if (user.signaturePattern) {
        addLine('', 'output-line');
        addLine('üéµ YOUR SIGNATURE PATTERN:', 'success-line');
        addLine(`üìù ${user.signaturePattern.description}`, 'info-line');
        
        const codeDisplay = document.createElement('div');
        codeDisplay.className = 'terminal-line';
        codeDisplay.style.cssText = `
          background: rgba(0, 255, 0, 0.05);
          border: 1px solid #00ff0033;
          border-radius: 4px;
          padding: 8px;
          margin: 8px 0;
          font-family: 'Courier New', monospace;
          color: #00ff88;
          overflow-x: auto;
          white-space: pre;
        `;
        codeDisplay.textContent = user.signaturePattern.strudelCode;
        document.getElementById('terminalContent').appendChild(codeDisplay);
      }
      
      addLine('', 'output-line');
      addLine('üí° Commands: "create new pattern", "update profile", "logout"', 'info-line');
    }
    
    function showAbout() {
      addLine('', 'output-line');
      addLine('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'success-line');
      addLine('üéµ NOT A LABEL - ABOUT', 'highlight-line');
      addLine('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'success-line');
      addLine('', 'output-line');
      
      addLine('A revolutionary AI-powered music creation platform', 'info-line');
      addLine('where identity is created through creativity, not forms.', 'output-line');
      addLine('', 'output-line');
      
      addLine('‚ú® FEATURES:', 'success-line');
      addLine('  ‚Ä¢ AI Music Generation from natural language', 'output-line');
      addLine('  ‚Ä¢ Musical Identity Creation (no boring signups!)', 'output-line');
      addLine('  ‚Ä¢ Community Discovery based on Musical DNA', 'output-line');
      addLine('  ‚Ä¢ Pattern Sharing, Remixing & Collaboration', 'output-line');
      addLine('  ‚Ä¢ Real-time Strudel pattern synthesis', 'output-line');
      addLine('', 'output-line');
      
      addLine('üß¨ TECHNOLOGY:', 'success-line');
      addLine('  ‚Ä¢ Custom NLP Engine for music understanding', 'output-line');
      addLine('  ‚Ä¢ Enhanced Pattern Generator with genre AI', 'output-line');
      addLine('  ‚Ä¢ Musical DNA matching algorithm', 'output-line');
      addLine('  ‚Ä¢ Strudel live coding integration', 'output-line');
      addLine('', 'output-line');
      
      addLine('üåç COMMUNITY:', 'success-line');
      addLine('  ‚Ä¢ 50+ simulated creators with unique profiles', 'output-line');
      addLine('  ‚Ä¢ Genre-based communities and tribes', 'output-line');
      addLine('  ‚Ä¢ Real-time pattern sharing and remixing', 'output-line');
      addLine('  ‚Ä¢ Collaborative music creation tools', 'output-line');
      addLine('', 'output-line');
      
      addLine('üí° Created with ‚ù§Ô∏è for musicians who think differently', 'highlight-line');
      addLine('üîó https://not-a-label.art', 'info-line');
      addLine('', 'output-line');
    }
    
    async function executeCommand(command) {
      if (!command.trim()) return;
      
      // Display command
      addLine(`nal@music:~$ ${command}`, 'input-line');
      
      // Simple command processing
      const lowerCommand = command.toLowerCase();
      
      if (lowerCommand === 'clear') {
        document.getElementById('terminalContent').innerHTML = '';
        addLine('‚úÖ Terminal cleared.', 'system-line');
        return;
      }
      
      if (lowerCommand === 'help') {
        addLine('', 'output-line');
        addLine('üéµ NOT A LABEL TERMINAL COMMANDS:', 'success-line');
        addLine('', 'output-line');
        addLine('üéº MUSIC GENERATION:', 'info-line');
        addLine('  create trap beat              - Generate trap music', 'output-line');
        addLine('  make lo-fi music for studying - Create chill beats', 'output-line');
        addLine('  generate drill pattern        - UK drill beats', 'output-line');
        addLine('  create aggressive trap        - High energy trap', 'output-line');
        addLine('  make something dreamy         - Atmospheric music', 'output-line');
        addLine('  create dark house music       - Dark electronic', 'output-line');
        addLine('', 'output-line');
        addLine('üé® IDENTITY & PROFILE:', 'info-line');
        addLine('  create musical identity       - Start identity creation', 'output-line');
        addLine('  signup                        - Begin account creation', 'output-line');
        addLine('  login                         - Sign into existing account', 'output-line');
        addLine('  my profile                    - View your musical profile', 'output-line');
        addLine('', 'output-line');
        addLine('üåç COMMUNITY & DISCOVERY:', 'info-line');
        addLine('  community feed                - View recent activity', 'output-line');
        addLine('  find my tribe                 - Discover similar creators', 'output-line');
        addLine('  explore [genre]               - Browse genre communities', 'output-line');
        addLine('  trending patterns             - See popular creations', 'output-line');
        addLine('  genre stats                   - Community statistics', 'output-line');
        addLine('', 'output-line');
        addLine('üéµ PATTERN SHARING:', 'info-line');
        addLine('  browse patterns               - Explore shared patterns', 'output-line');
        addLine('  my patterns                   - View your saved patterns', 'output-line');
        addLine('  share pattern                 - Share current pattern', 'output-line');
        addLine('  remix [pattern]               - Remix a shared pattern', 'output-line');
        addLine('  collab with [artist]          - Start collaboration', 'output-line');
        addLine('', 'output-line');
        addLine('üõ†Ô∏è SYSTEM COMMANDS:', 'info-line');
        addLine('  clear                         - Clear terminal', 'output-line');
        addLine('  help                          - Show this help', 'output-line');
        addLine('', 'output-line');
        addLine('‚úÖ AI-powered music generation & identity system active!', 'success-line');
        return;
      }
      
      // Musical Identity Commands
      if (lowerCommand.includes('create musical identity') || lowerCommand === 'signup' || lowerCommand.includes('create account')) {
        if (musicalIdentityCreator) {
          musicalIdentityCreator.start();
          return;
        } else {
          addLine('‚ùå Musical Identity Creator not available', 'error-line');
          return;
        }
      }
      
      if (lowerCommand === 'login') {
        addLine('üéµ Musical Identity Login:', 'success-line');
        addLine('üí° Try: "I\'m [your artist name]" or "login as [name]"', 'info-line');
        addLine('üé® Or create a new identity with: "create musical identity"', 'output-line');
        return;
      }
      
      if (lowerCommand.includes('my profile') || lowerCommand.includes('profile')) {
        if (currentUser) {
          showUserProfile(currentUser);
        } else {
          addLine('‚ùå Not logged in. Try "login" or "create musical identity"', 'error-line');
        }
        return;
      }
      
      if (lowerCommand === 'logout') {
        if (currentUser) {
          const artistName = currentUser.artistName;
          window.SimpleAuthSystem.logout();
          currentUser = null;
          addLine(`üëã Goodbye, ${artistName}! Your musical identity is saved.`, 'success-line');
          addLine('üí° Use "login" or "create musical identity" to return', 'info-line');
        } else {
          addLine('‚ùå You are not logged in', 'error-line');
        }
        return;
      }
      
      // Community Commands
      if (lowerCommand.includes('community feed') || lowerCommand === 'community') {
        if (communitySystem) {
          communitySystem.showCommunityFeed();
          return;
        }
      }
      
      if (lowerCommand.includes('find my tribe') || lowerCommand.includes('my tribe')) {
        if (communitySystem) {
          communitySystem.findMusicalTribe(currentUser);
          return;
        }
      }
      
      if (lowerCommand.includes('explore ')) {
        const genre = command.replace(/explore\s+/i, '').trim();
        if (communitySystem && genre) {
          communitySystem.exploreGenre(genre);
          return;
        }
      }
      
      if (lowerCommand.includes('trending patterns') || lowerCommand === 'trending') {
        if (communitySystem) {
          communitySystem.showTrendingPatterns();
          return;
        }
      }
      
      if (lowerCommand.includes('genre stats') || lowerCommand === 'stats') {
        if (communitySystem) {
          communitySystem.showGenreStats();
          return;
        }
      }
      
      // Pattern Sharing Commands
      if (lowerCommand.includes('browse patterns') || lowerCommand === 'browse') {
        if (patternSharingSystem) {
          const filter = lowerCommand.includes('recent') ? 'recent' : 
                        lowerCommand.includes('remixable') ? 'remixable' : 'popular';
          patternSharingSystem.browsePatterns(filter);
          return;
        }
      }
      
      if (lowerCommand === 'my patterns' || lowerCommand.includes('show my patterns')) {
        if (patternSharingSystem) {
          patternSharingSystem.showMyPatterns();
          return;
        }
      }
      
      if (lowerCommand.includes('share pattern') || lowerCommand === 'share') {
        if (patternSharingSystem && currentPattern) {
          const titleMatch = command.match(/share\s+(?:pattern\s+)?(?:as\s+)?["']?([^"']+)["']?/i);
          const title = titleMatch ? titleMatch[1].trim() : 'Untitled Pattern';
          patternSharingSystem.sharePattern(currentPattern, { title: title });
          return;
        } else if (!currentPattern) {
          addLine('‚ùå No pattern to share. Create one first!', 'error-line');
          return;
        }
      }
      
      if (lowerCommand.includes('collab with ')) {
        const artist = command.replace(/collab(?:orate)?\s+with\s+/i, '').trim();
        if (patternSharingSystem && artist) {
          patternSharingSystem.startCollaboration(artist);
          return;
        }
      }
      
      if (lowerCommand.includes('save pattern')) {
        if (currentPattern) {
          const titleMatch = command.match(/save\s+(?:pattern\s+)?(?:as\s+)?["']?([^"']+)["']?/i);
          const title = titleMatch ? titleMatch[1].trim() : null;
          if (patternSharingSystem) {
            patternSharingSystem.savePattern(currentPattern, title);
          } else {
            savePattern(currentPattern); // Fallback to basic save
          }
          return;
        } else {
          addLine('‚ùå No pattern to save. Create one first!', 'error-line');
          return;
        }
      }
      
      if (lowerCommand.includes('create') || lowerCommand.includes('make') || lowerCommand.includes('generate')) {
        generateMusic(command);
        return;
      }
      
      // Check if Musical Identity Creator is handling input
      if (musicalIdentityCreator && musicalIdentityCreator.isActive) {
        const handled = await musicalIdentityCreator.handleInput(command);
        if (handled) return;
      }
      
      // Try NLP processing for other commands
      if (nlp) {
        const result = nlp.processCommand(command);
        if (result.response) {
          addLine(result.response, 'info-line');
          return;
        }
      }
      
      // Easter eggs and fun commands
      if (lowerCommand === 'about' || lowerCommand === 'credits') {
        showAbout();
        return;
      }
      
      if (lowerCommand.includes('love') || lowerCommand === '‚ù§Ô∏è' || lowerCommand === 'heart') {
        addLine('', 'output-line');
        addLine('‚ù§Ô∏è Music is love, love is music!', 'highlight-line');
        addLine('üéµ Creating a special pattern just for you...', 'success-line');
        generateMusic('create a love song with dreamy vibes');
        return;
      }
      
      if (lowerCommand === 'party' || lowerCommand === 'üéâ') {
        addLine('', 'output-line');
        addLine('üéâ PARTY MODE ACTIVATED!', 'highlight-line');
        addLine('üï∫ Let\'s get this party started!', 'success-line');
        generateMusic('create energetic party house music');
        return;
      }
      
      // Default response
      addLine('', 'output-line');
      addLine(`‚úÖ Command processed: "${command}"`, 'success-line');
      addLine('üí° Try: "create trap beat" or "make lo-fi music"', 'info-line');
      addLine('', 'output-line');
    }
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
      const terminalInput = document.getElementById('terminalInput');
      
      console.log('üìã Initializing terminal...');
      
      if (!terminalInput) {
        console.error('‚ùå Terminal input not found');
        return;
      }
      
      // Initialize AI components
      try {
        // Initialize Nala AI (DeepSeek R1)
        nalaAI = new NalaAI();
        
        // Initialize supporting systems
        nlp = new NaturalLanguageProcessor();
        patternGenerator = new EnhancedPatternGenerator();
        
        // Set fallback generator for Nala AI
        nalaAI.setFallbackGenerator(patternGenerator);
        
        musicalIdentityCreator = new MusicalIdentityCreator({
          addLine: addLine,
          addHTML: addHTML,
          focusInput: () => terminalInput.focus()
        });
        communitySystem = new CommunitySystem({
          addLine: addLine,
          addHTML: addHTML,
          currentUser: () => currentUser
        });
        patternSharingSystem = new PatternSharingSystem({
          addLine: addLine,
          addHTML: addHTML,
          currentUser: () => currentUser,
          playPattern: playPattern
        });
        window.patternSharingSystem = patternSharingSystem; // Make globally accessible
        
        // Check AI health
        nalaAI.checkHealth().then(health => {
          console.log('ü§ñ Nala AI Health:', health);
          if (health.status === 'ok') {
            addLine('ü§ñ Nala AI (DeepSeek R1) online & ready', 'system-line');
          } else {
            addLine('ü§ñ Nala AI offline - using fallback generation', 'info-line');
          }
        });
        
        addLine('üß† AI music generation & community system initialized', 'system-line');
      } catch (error) {
        console.error('AI initialization error:', error);
        addLine('‚ö†Ô∏è AI system loading... some features may be limited', 'info-line');
      }
      
      // Add Enter key handler
      terminalInput.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
          event.preventDefault();
          const command = terminalInput.value.trim();
          
          if (command) {
            executeCommand(command).catch(error => {
              console.error('Command execution error:', error);
              addLine('‚ùå Command execution error', 'error-line');
            });
            terminalInput.value = '';
          }
        }
      });
      
      // Focus the input
      terminalInput.focus();
      
      // Check for existing user session
      const existingUser = window.SimpleAuthSystem?.getCurrentUser();
      if (existingUser) {
        currentUser = existingUser;
        addLine(`üéµ Welcome back, ${existingUser.artistName}!`, 'success-line');
        addLine('üí° Your musical identity has been restored', 'info-line');
      }
      
      console.log('‚úÖ Terminal ready!');
      addLine('üéØ Terminal loaded with AI music generation', 'system-line');
      if (currentUser) {
        addLine('‚å®Ô∏è Try "create new pattern" or "my profile"!', 'info-line');
      } else {
        addLine('‚å®Ô∏è Try "create musical identity" or "create trap beat"!', 'info-line');
      }
    });
    
    // Register service worker for PWA features
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js', { scope: '/' })
          .then(registration => {
            console.log('SW registered: ', registration);
          })
          .catch(registrationError => {
            console.log('SW registration failed: ', registrationError);
          });
      });
    }
  </script>
</body>
</html>